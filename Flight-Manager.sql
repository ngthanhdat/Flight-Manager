CREATE DATABASE FlightManager
ON
(
	NAME = FlightManager_dat,
	FILENAME = 'D:\Study\Repositories\temp\Basic SQL\FlightManager.mdf',
	SIZE = 200,
	FILEGROWTH = 80% 
)
LOG ON
(
	NAME = FlightManager_log,
	FILENAME = 'D:\Study\Repositories\temp\Basic SQL\FlightManager.ldf',
	SIZE = 200,
	FILEGROWTH = 80% 
)
GO
USE FlightManager

GO
CREATE TABLE KHACHHANG
(
	MAKH varchar(15),
	TEN Nvarchar(30) not null,
	DCHI varchar(50) not null,
	DTHOAI varchar(12) not null,
	CONSTRAINT PK_KHACHHANG PRIMARY KEY(MAKH)
);
 
GO
CREATE TABLE LICHBAY
(
	NGAYDI date,
	MACB varchar(4),
	SOHIEU int not null,
	MALOAI varchar(15) not null,
	CONSTRAINT PK_LICHBAY PRIMARY KEY(NGAYDI,MACB) 
);

GO
CREATE TABLE DATCHO
(
	MAKH varchar(15),
	NGAYDI date,
	MACB varchar(4),
	CONSTRAINT PK_DATCHO PRIMARY KEY(MAKH,NGAYDI,MACB)
);

GO
CREATE TABLE CHUYENBAY
(
	MACB varchar(4) not null,
	SBDI varchar(3) not null,
	SBDEN varchar(3) not null,
	GIODI time not null,
	GIODEN time not null
	CONSTRAINT PK_CHUYENBAY PRIMARY KEY(MACB)
);

GO
CREATE TABLE MAYBAY
(
	SOHIEU int not null, 
	MALOAI varchar(15) not null
	CONSTRAINT PK_MAYBAY PRIMARY KEY(SOHIEU,MALOAI)
);

GO
CREATE TABLE LOAIMB
(
	HANGSX varchar(15) not null,
	MALOAI varchar(15) not null
	CONSTRAINT PK_LOAIMAYBAY PRIMARY KEY(MALOAI)
);

GO
CREATE TABLE KHANANG
(
	MANV varchar(15) not null,
	MALOAI varchar(15) not null
	CONSTRAINT PK_KHANANG PRIMARY KEY(MANV,MALOAI)
);

GO 
CREATE TABLE NHANVIEN
(
	MANV varchar(15) not null,
	TEN Nvarchar(30) not null,
	DCHI varchar(50) not null,
	DTHOAI varchar(12) not null,
	LUONG float not null,
	LOAINV bit not null
	CONSTRAINT PK_NHANVIEN PRIMARY KEY(MANV)
);

GO
create table PHANCONG
(
	MANV varchar(15) not null,
	NGAYDI date not null,
	MACB varchar(4) not null
	CONSTRAINT PK_PHANCONG PRIMARY KEY(MANV,NGAYDI,MACB)
);

--ALTER TABLE NHANVIEN ADD CONSTRAINT DK_LuongCoBan check (LUONG > 95000)
ALTER TABLE KHACHHANG ADD CONSTRAINT DF_DTHOAI DEFAULT 'Chua Cap Nhat' FOR DTHOAI
--ALTER TABLE CHUYENBAY ADD CONSTRAINT df_GioDi default '00:00' for GIODI
--ALTER TABLE CHUYENBAY ADD CONSTRAINT df_GioDen default '00:00' for GIODEN
--ALTER TABLE PHANCONG ADD CONSTRAINT df_NgayDi default '00/00/00' for NGAYDI
--ALTER TABLE MAYBAY ADD CONSTRAINT df_SoHieu default 1 for SOHIEU

ALTER TABLE DATCHO ADD CONSTRAINT FK_DATCHO_KHACHHANG FOREIGN KEY(MAKH) REFERENCES KHACHHANG(MAKH)
ALTER TABLE DATCHO ADD CONSTRAINT FK_DATCHO_LICHBAY FOREIGN KEY(NGAYDI,MACB) REFERENCES LICHBAY(NGAYDI,MACB)
ALTER TABLE LICHBAY ADD CONSTRAINT FK_LICHBAY_CHUYENBAY FOREIGN KEY(MACB) REFERENCES CHUYENBAY(MACB)
ALTER TABLE LICHBAY ADD CONSTRAINT FK_LICHBAY_MAYBAY FOREIGN KEY(SOHIEU,MALOAI) REFERENCES MAYBAY(SOHIEU,MALOAI)
ALTER TABLE PHANCONG ADD CONSTRAINT FK_PHANCONG_LICHBAY FOREIGN KEY(NGAYDI,MACB) REFERENCES LICHBAY(NGAYDI,MACB)
ALTER TABLE MAYBAY ADD CONSTRAINT FK_MAYBAY_LOAIMB FOREIGN KEY(MALOAI) REFERENCES LOAIMB(MALOAI)
ALTER TABLE KHANANG ADD CONSTRAINT FK_KHANANG_LOAIMN FOREIGN KEY(MALOAI) REFERENCES LOAIMB(MALOAI)
ALTER TABLE KHANANG ADD CONSTRAINT FK_KHANANG_NHANVIEN FOREIGN KEY(MANV) REFERENCES NHANVIEN(MANV)
ALTER TABLE PHANCONG ADD CONSTRAINT FK_PHANCONG_NHANVIEN FOREIGN KEY(MANV) REFERENCES NHANVIEN(MANV)

INSERT INTO NHANVIEN(MANV,TEN,DCHI,DTHOAI,LUONG,LOAINV) VALUES('1006','Chi','12/6 Nguyen Kiem','8120012',150000,0)
INSERT INTO NHANVIEN(MANV,TEN,DCHI,DTHOAI,LUONG,LOAINV) VALUES('1005','Giao','65 Nguyen Thai Son','8324467',500000,0)
INSERT INTO NHANVIEN(MANV,TEN,DCHI,DTHOAI,LUONG,LOAINV) VALUES('1001','Huong','8 Dien Bien Phu','8330733',500000,1)
INSERT INTO NHANVIEN(MANV,TEN,DCHI,DTHOAI,LUONG,LOAINV) VALUES('1002','Phong','1 Ly Thuong Kiet','8308117',450000,1)
INSERT INTO NHANVIEN(MANV,TEN,DCHI,DTHOAI,LUONG,LOAINV) VALUES('1004','Phuong','351 Lac Long Quan','8308155',250000,0)
INSERT INTO NHANVIEN(MANV,TEN,DCHI,DTHOAI,LUONG,LOAINV) VALUES('1003','Quang','78 Truong Dinh','8324461',350000,1)
INSERT INTO NHANVIEN(MANV,TEN,DCHI,DTHOAI,LUONG,LOAINV) VALUES('1007','Tam','36 Nguyen Van Cu','8458188',500000,0)

INSERT INTO LOAIMB(HANGSX,MALOAI) VALUES('Airbus','A310')
INSERT INTO LOAIMB(HANGSX,MALOAI) VALUES('Airbus','A320')
INSERT INTO LOAIMB(HANGSX,MALOAI) VALUES('Airbus','A330')
INSERT INTO LOAIMB(HANGSX,MALOAI) VALUES('Airbus','A340')
INSERT INTO LOAIMB(HANGSX,MALOAI) VALUES('Boeing','B727')
INSERT INTO LOAIMB(HANGSX,MALOAI) VALUES('Boeing','B747')
INSERT INTO LOAIMB(HANGSX,MALOAI) VALUES('Boeing','B757')
INSERT INTO LOAIMB(HANGSX,MALOAI) VALUES('MD','DC10')
INSERT INTO LOAIMB(HANGSX,MALOAI) VALUES('MD','DC9')

INSERT INTO KHANANG(MANV,MALOAI) VALUES('1001','B727')
INSERT INTO KHANANG(MANV,MALOAI) VALUES('1001','B747')
INSERT INTO KHANANG(MANV,MALOAI) VALUES('1001','DC10')
INSERT INTO KHANANG(MANV,MALOAI) VALUES('1001','DC9')
INSERT INTO KHANANG(MANV,MALOAI) VALUES('1002','A320')
INSERT INTO KHANANG(MANV,MALOAI) VALUES('1002','A340')
INSERT INTO KHANANG(MANV,MALOAI) VALUES('1002','B757')
INSERT INTO KHANANG(MANV,MALOAI) VALUES('1002','DC9')
INSERT INTO KHANANG(MANV,MALOAI) VALUES('1003','A310')
INSERT INTO KHANANG(MANV,MALOAI) VALUES('1003','DC9')

INSERT INTO KHACHHANG(MAKH,TEN,DCHI,DTHOAI) VALUES('0009','Nga','223 Nguyen Trai','8932320')
INSERT INTO KHACHHANG(MAKH,TEN,DCHI,DTHOAI) VALUES('0101','Anh','567 Tran Phu','8826729')
INSERT INTO KHACHHANG(MAKH,TEN,DCHI,DTHOAI) VALUES('0045','Thu','285 Le Loi','8932203')
INSERT INTO KHACHHANG(MAKH,TEN,DCHI,DTHOAI) VALUES('0012','Ha','435 Quang Trung','8933232')
INSERT INTO KHACHHANG(MAKH,TEN,DCHI,DTHOAI) VALUES('0238','Hung','456 Pasteur','9812101')
INSERT INTO KHACHHANG(MAKH,TEN,DCHI,DTHOAI) VALUES('0397','Thanh','234 Le Van Si','8952943')
INSERT INTO KHACHHANG(MAKH,TEN,DCHI,DTHOAI) VALUES('0582','Mai','789 Nguyen Du','')
INSERT INTO KHACHHANG(MAKH,TEN,DCHI,DTHOAI) VALUES('0934','Minh','678 Le Lai','')
INSERT INTO KHACHHANG(MAKH,TEN,DCHI,DTHOAI) VALUES('0091','Hai','345 Hung Vuong','8893223')
INSERT INTO KHACHHANG(MAKH,TEN,DCHI,DTHOAI) VALUES('0314','Phuong','395 Vo Van Tan','8232320')
INSERT INTO KHACHHANG(MAKH,TEN,DCHI,DTHOAI) VALUES('0613','Vu','348 CMT8','8343232')
INSERT INTO KHACHHANG(MAKH,TEN,DCHI,DTHOAI) VALUES('0586','Son','123 Bach Dang','8556223')
INSERT INTO KHACHHANG(MAKH,TEN,DCHI,DTHOAI) VALUES('0422','Tien','75 Nguyen Thong','8332222')

INSERT INTO CHUYENBAY(MACB,SBDI,SBDEN,GIODI,GIODEN) VALUES('100','SLC','BOS','08:00','17:50')
INSERT INTO CHUYENBAY(MACB,SBDI,SBDEN,GIODI,GIODEN) VALUES('112','DCA','DEN','14:00','18:07')
INSERT INTO CHUYENBAY(MACB,SBDI,SBDEN,GIODI,GIODEN) VALUES('121','STL','SLC','07:00','09:13')
INSERT INTO CHUYENBAY(MACB,SBDI,SBDEN,GIODI,GIODEN) VALUES('122','STL','YYV','08:30','10:19')
INSERT INTO CHUYENBAY(MACB,SBDI,SBDEN,GIODI,GIODEN) VALUES('206','DFW','STL','09:00','11:40')
INSERT INTO CHUYENBAY(MACB,SBDI,SBDEN,GIODI,GIODEN) VALUES('330','JFK','YYV','16:00','18:53')
INSERT INTO CHUYENBAY(MACB,SBDI,SBDEN,GIODI,GIODEN) VALUES('334','ORD','MIA','12:00','14:14')
INSERT INTO CHUYENBAY(MACB,SBDI,SBDEN,GIODI,GIODEN) VALUES('335','MIA','ORD','15:00','17:14')
INSERT INTO CHUYENBAY(MACB,SBDI,SBDEN,GIODI,GIODEN) VALUES('336','ORD','MIA','18:00','20:14')
INSERT INTO CHUYENBAY(MACB,SBDI,SBDEN,GIODI,GIODEN) VALUES('337','MIA','ORD','20:30','23:53')
INSERT INTO CHUYENBAY(MACB,SBDI,SBDEN,GIODI,GIODEN) VALUES('394','DFW','MIA','19:00','21:30')
INSERT INTO CHUYENBAY(MACB,SBDI,SBDEN,GIODI,GIODEN) VALUES('395','MIA','DFW','21:00','23:43')
INSERT INTO CHUYENBAY(MACB,SBDI,SBDEN,GIODI,GIODEN) VALUES('449','CDG','DEN','10:00','19:29')
INSERT INTO CHUYENBAY(MACB,SBDI,SBDEN,GIODI,GIODEN) VALUES('930','YYV','DCA','13:00','16:10')
INSERT INTO CHUYENBAY(MACB,SBDI,SBDEN,GIODI,GIODEN) VALUES('931','DCA','YYV','17:00','18:10')
INSERT INTO CHUYENBAY(MACB,SBDI,SBDEN,GIODI,GIODEN) VALUES('932','DCA','YYV','18:00','19:10')
INSERT INTO CHUYENBAY(MACB,SBDI,SBDEN,GIODI,GIODEN) VALUES('991','BOS','ORD','17:00','18:22')

INSERT INTO MAYBAY(SOHIEU,MALOAI) VALUES('10','B747')
INSERT INTO MAYBAY(SOHIEU,MALOAI) VALUES('11','B727')
INSERT INTO MAYBAY(SOHIEU,MALOAI) VALUES('13','B727')
INSERT INTO MAYBAY(SOHIEU,MALOAI) VALUES('13','B747')
INSERT INTO MAYBAY(SOHIEU,MALOAI) VALUES('21','DC10')
INSERT INTO MAYBAY(SOHIEU,MALOAI) VALUES('21','DC9')
INSERT INTO MAYBAY(SOHIEU,MALOAI) VALUES('22','B757')
INSERT INTO MAYBAY(SOHIEU,MALOAI) VALUES('22','DC9')
INSERT INTO MAYBAY(SOHIEU,MALOAI) VALUES('23','DC9')
INSERT INTO MAYBAY(SOHIEU,MALOAI) VALUES('24','DC9')
INSERT INTO MAYBAY(SOHIEU,MALOAI) VALUES('70','A310')
INSERT INTO MAYBAY(SOHIEU,MALOAI) VALUES('80','A310')
INSERT INTO MAYBAY(SOHIEU,MALOAI) VALUES('93','B757')

INSERT INTO LICHBAY(NGAYDI,MACB,SOHIEU,MALOAI) VALUES('11/1/2000','100',80,'A310')
INSERT INTO LICHBAY(NGAYDI,MACB,SOHIEU,MALOAI) VALUES('11/1/2000','112',21,'DC10')
INSERT INTO LICHBAY(NGAYDI,MACB,SOHIEU,MALOAI) VALUES('11/1/2000','206',22,'DC9')
INSERT INTO LICHBAY(NGAYDI,MACB,SOHIEU,MALOAI) VALUES('11/1/2000','334',10,'B747')
INSERT INTO LICHBAY(NGAYDI,MACB,SOHIEU,MALOAI) VALUES('11/1/2000','395',23,'DC9')
INSERT INTO LICHBAY(NGAYDI,MACB,SOHIEU,MALOAI) VALUES('11/1/2000','991',22,'B757')
INSERT INTO LICHBAY(NGAYDI,MACB,SOHIEU,MALOAI) VALUES('11/1/2000','337',10,'B747')
INSERT INTO LICHBAY(NGAYDI,MACB,SOHIEU,MALOAI) VALUES('10/31/2000','100',11,'B727')
INSERT INTO LICHBAY(NGAYDI,MACB,SOHIEU,MALOAI) VALUES('10/31/2000','112',11,'B727')
INSERT INTO LICHBAY(NGAYDI,MACB,SOHIEU,MALOAI) VALUES('10/31/2000','206',13,'B727')
INSERT INTO LICHBAY(NGAYDI,MACB,SOHIEU,MALOAI) VALUES('10/31/2000','334',10,'B747')
INSERT INTO LICHBAY(NGAYDI,MACB,SOHIEU,MALOAI) VALUES('10/31/2000','335',10,'B747')
INSERT INTO LICHBAY(NGAYDI,MACB,SOHIEU,MALOAI) VALUES('10/31/2000','337',24,'DC9')
INSERT INTO LICHBAY(NGAYDI,MACB,SOHIEU,MALOAI) VALUES('10/31/2000','449',70,'A310')

INSERT INTO PHANCONG(MANV,NGAYDI,MACB) VALUES('1001','11/01/2000','100')
INSERT INTO PHANCONG(MANV,NGAYDI,MACB) VALUES('1001','10/31/2000','100')
INSERT INTO PHANCONG(MANV,NGAYDI,MACB) VALUES('1002','11/01/2000','100')
INSERT INTO PHANCONG(MANV,NGAYDI,MACB) VALUES('1002','10/31/2000','100')
INSERT INTO PHANCONG(MANV,NGAYDI,MACB) VALUES('1003','10/31/2000','100')
INSERT INTO PHANCONG(MANV,NGAYDI,MACB) VALUES('1003','10/31/2000','337')
INSERT INTO PHANCONG(MANV,NGAYDI,MACB) VALUES('1004','10/31/2000','100')
INSERT INTO PHANCONG(MANV,NGAYDI,MACB) VALUES('1004','10/31/2000','337')
INSERT INTO PHANCONG(MANV,NGAYDI,MACB) VALUES('1005','10/31/2000','337')
INSERT INTO PHANCONG(MANV,NGAYDI,MACB) VALUES('1006','11/01/2000','991')
INSERT INTO PHANCONG(MANV,NGAYDI,MACB) VALUES('1006','10/31/2000','337')
INSERT INTO PHANCONG(MANV,NGAYDI,MACB) VALUES('1007','11/01/2000','112')
INSERT INTO PHANCONG(MANV,NGAYDI,MACB) VALUES('1007','11/01/2000','991')
INSERT INTO PHANCONG(MANV,NGAYDI,MACB) VALUES('1007','10/31/2000','206')

INSERT INTO DATCHO(MAKH,NGAYDI,MACB) VALUES('0009','11/01/2000','100')
INSERT INTO DATCHO(MAKH,NGAYDI,MACB) VALUES('0009','10/31/2000','449')
INSERT INTO DATCHO(MAKH,NGAYDI,MACB) VALUES('0045','11/01/2000','991')
INSERT INTO DATCHO(MAKH,NGAYDI,MACB) VALUES('0012','10/31/2000','206')
INSERT INTO DATCHO(MAKH,NGAYDI,MACB) VALUES('0238','10/31/2000','334')
INSERT INTO DATCHO(MAKH,NGAYDI,MACB) VALUES('0582','11/01/2000','991')
INSERT INTO DATCHO(MAKH,NGAYDI,MACB) VALUES('0091','11/01/2000','100')
INSERT INTO DATCHO(MAKH,NGAYDI,MACB) VALUES('0314','10/31/2000','449')
INSERT INTO DATCHO(MAKH,NGAYDI,MACB) VALUES('0613','11/01/2000','100')
INSERT INTO DATCHO(MAKH,NGAYDI,MACB) VALUES('0586','11/01/2000','991')
INSERT INTO DATCHO(MAKH,NGAYDI,MACB) VALUES('0586','10/31/2000','100')
INSERT INTO DATCHO(MAKH,NGAYDI,MACB) VALUES('0422','10/31/2000','449')


/* Q1 */
SELECT *
FROM LICHBAY as LB join (NHANVIEN join PHANCONG on NHANVIEN.MANV=PHANCONG.MANV) 
			       on LB.MACB=PHANCONG.MACB
WHERE LOAINV = 1 and LB.MALOAI='B747' and DATEDIFF (dd,LB.NGAYDI,getdate())>1

/* Q2 */
SELECT *
FROM LICHBAY as LB join CHUYENBAY as CB
			       on LB.MACB = CB.MACB
WHERE CB.SBDI='DCA' and CB.GIODI between '14:00:00' and '18:00:00' 

/* Q3 */
SELECT DISTINCT NV.MANV, NV.TEN
FROM (CHUYENBAY as CB join LICHBAY as LB 
					  on CB.MACB = LB.MACB) 
join (PHANCONG as PC join NHANVIEN as NV 
					 on PC.MANV = NV.MANV) 
on PC.NGAYDI = LB.NGAYDI and PC.MACB = LB.MACB
WHERE LB.MACB = '100' and CB.SBDI='SLC'

/* Q4 */
SELECT DISTINCT LB.SOHIEU, LB.MALOAI
FROM LICHBAY as LB join CHUYENBAY as CB
				   on LB.MACB = CB.MACB
WHERE CB.SBDI='MIA' and datediff (dd,LB.NGAYDI,getdate())>1

/* Q5 */
SELECT *
FROM (KHACHHANG as KH join DATCHO as DC 
					  on KH.MAKH = DC.MAKH) 
join (LICHBAY as LB join CHUYENBAY as CB 
					on LB.MACB = CB.MACB)
on DC.NGAYDI = LB.NGAYDI and DC.MACB = CB.MACB
ORDER BY LB.MACB ASC , LB.NGAYDI DESC 

/* Q6 */
SELECT PC.MACB,PC.NGAYDI,NV.TEN,NV.DCHI,NV.DTHOAI
FROM PHANCONG as PC join NHANVIEN as NV 
                    on PC.MANV=NV.MANV
ORDER BY PC.MACB ASC, PC.NGAYDI DESC

/* Q7 */
SELECT CB.MACB, PC.NGAYDI, PC.MANV, NV.TEN, CB.SBDEN
FROM (CHUYENBAY CB join PHANCONG PC on CB.MACB = PC.MACB) 
	join NHANVIEN NV on NV.MANV = PC.MANV join LICHBAY LB on LB.MACB = CB.MACB
WHERE CB.SBDEN = 'ORD' AND NV.LOAINV = 1 AND DATEDIFF(dd,LB.NGAYDI,getdate())>1

/* Q8 */
SELECT CB.MACB, PC.NGAYDI, NV.TEN
FROM CHUYENBAY CB join PHANCONG PC on CB.MACB = PC.MACB join NHANVIEN NV on NV.MANV = PC.MANV
WHERE NV.MANV = 1001

/* Q9 */
SELECT CB.MACB, CB.SBDI, CB.GIODI, CB.GIODEN, PC.NGAYDI
FROM (CHUYENBAY CB join PHANCONG PC on CB.MACB = PC.MACB) 
	join NHANVIEN NV on NV.MANV = PC.MANV join LICHBAY LB on LB.MACB = CB.MACB
WHERE CB.SBDEN = 'DEN' AND DATEDIFF(dd,LB.NGAYDI,getdate())>1
ORDER BY PC.NGAYDI DESC, CB.SBDI ASC

/* Q10 */
SELECT LMB.HANGSX, KN.MALOAI, NV.TEN, NV.MANV
FROM LOAIMB LMB join KHANANG KN on KN.MALOAI = LMB.MALOAI	
	join NHANVIEN NV on NV.MANV = KN.MANV
WHERE NV.LOAINV = 1

/* Q11 */
SELECT NV.MANV, NV.TEN
FROM PHANCONG PC join NHANVIEN NV on PC.MANV = NV.MANV
WHERE PC.MACB = '100' AND PC.NGAYDI = '2000-11-01'

/* Q12 */
SELECT PC.MACB, NV.MANV, NV.TEN
FROM NHANVIEN NV join PHANCONG PC on PC.MANV = NV.MANV
	join LICHBAY LB on LB.MACB = PC.MACB
		join CHUYENBAY CB on CB.MACB = LB.MACB
WHERE LB.NGAYDI = '2000-10-31' AND CB.SBDI = 'MIA' AND CB.GIODI = '20:30:00.0000000'

/* Q13 */
SELECT LB.MACB, MB.SOHIEU, LMB.MALOAI, LMB.HANGSX
FROM LICHBAY LB join MAYBAY MB on MB.SOHIEU = LB.SOHIEU 
	join LOAIMB LMB on LMB.MALOAI = MB.MALOAI
		join KHANANG KN on KN.MALOAI = LMB.MALOAI
			join NHANVIEN NV on NV.MANV = KN.MANV
WHERE NV.TEN = 'Quang' AND DATEDIFF(dd,LB.NGAYDI,getdate()) > 1

/* Q14 */
SELECT NV.TEN FROM NHANVIEN NV WHERE (NV.MANV NOT IN (SELECT PC.MANV FROM PHANCONG PC))

/* Q15 */
SELECT DISTINCT KH.TEN
FROM KHACHHANG KH join DATCHO DC on DC.MAKH = KH.MAKH
	join LICHBAY LB on LB.MACB =  DC.MACB and LB.NGAYDI = DC.NGAYDI
		join CHUYENBAY CB on CB.MACB = LB.MACB
			join LOAIMB LMB on LMB.MALOAI = LB.MALOAI
WHERE LMB.HANGSX = 'Boeing'

/* Q16 */ 
SELECT LB.MACB
FROM LICHBAY LB
WHERE LB.MALOAI = 'B747' AND LB.SOHIEU = 10

/* Q17 */
SELECT count(CB.MACB) SoLuongChuyenBay, CB.SBDEN
FROM CHUYENBAY CB
GROUP BY CB.SBDEN
ORDER BY count(CB.MACB) ASC

/* Q18 */
SELECT count(CB.MACB) SoLuongChuyenBay, CB.SBDI
FROM CHUYENBAY CB
GROUP BY CB.SBDI
ORDER BY count(CB.MACB) ASC

/* Q19 */
SELECT CB.SBDI, LB.NGAYDI, count(CB.MACB) SoLuongChuyenBay
FROM CHUYENBAY CB join LICHBAY LB on CB.MACB = LB.MACB
GROUP BY CB.SBDI, LB.NGAYDI

/* Q20 */
SELECT CB.SBDEN, LB.NGAYDI, count(CB.MACB) SoLuongChuyenBay
FROM CHUYENBAY CB join LICHBAY LB on CB.MACB = LB.MACB
GROUP BY CB.SBDEN, LB.NGAYDI

/* Q21 */
SELECT PC.MACB, PC.NGAYDI, count(NV.MANV) SoLuongNVKhongPhaiPhiCong
FROM PHANCONG PC join NHANVIEN NV on PC.MANV = NV.MANV
WHERE NV.LOAINV <> 1
GROUP BY PC.NGAYDI,PC.MACB

/* Q22 */
SELECT count(CB.MACB) SoLuongChuyenBay
FROM CHUYENBAY CB join LICHBAY LB on CB.MACB = LB.MACB
WHERE CB.SBDI = 'MIA' AND LB.NGAYDI = '2000-11-01'
GROUP BY (CB.SBDI)

/* Q23 */
SELECT CB.MACB, PC.NGAYDI, count(PC.MANV) SoLuongNhanVien
FROM CHUYENBAY CB join PHANCONG PC on CB.MACB = PC.MACB
GROUP BY CB.MACB, PC.NGAYDI
ORDER BY count(PC.MANV) DESC

/* Q24 */
SELECT CB.MACB, LB.NGAYDI, count(DC.MAKH) SoLuongKhachHang
FROM DATCHO DC join LICHBAY LB on DC.MACB = LB.MACB and DC.NGAYDI = LB.NGAYDI
	join CHUYENBAY CB on CB.MACB = LB.MACB
GROUP BY CB.MACB, LB.NGAYDI

/* Q25 */
SELECT CB.MACB, PC.NGAYDI, sum(NV.LUONG) TongLuongNhanVien
FROM CHUYENBAY CB join PHANCONG PC on CB.MACB = PC.MACB
	join NHANVIEN NV on NV.MANV = PC.MANV
GROUP BY CB.MACB, PC.NGAYDI
ORDER BY count(NV.LUONG)

/* Q26 */
SELECT AVG(Luong) LuongTrungBinh
FROM NHANVIEN
WHERE LOAINV <> 1

/* Q27 */
SELECT AVG(Luong) LuongTrungBinhPhiCong
FROM NHANVIEN
WHERE LOAINV = 1

/* Q28 */
SELECT MB.MALOAI, count(CB.MACB) SoLuongChuyenBay
FROM CHUYENBAY CB join LICHBAY LB on CB.MACB = LB.MACB
	join MAYBAY MB on MB.MALOAI = LB.MALOAI
WHERE DATEDIFF(dd,LB.NGAYDI,getdate()) > 1
GROUP BY (MB.MALOAI)

/* Q29 */
SELECT SBDI, count(MACB) SoChuyenBay
FROM CHUYENBAY 
WHERE GIODI between '10:00:00.0000000' and '22:00:00.0000000'
GROUP BY (SBDI)
HAVING count(MACB) > 2

/* Q30 */
SELECT PC.NGAYDI, NV.TEN, count(PC.MACB) SoChuyenBayDuocPhanCong
FROM NHANVIEN NV join PHANCONG PC on NV.MANV = PC.MANV
WHERE NV.LOAINV = 1 
GROUP BY PC.NGAYDI, NV.TEN
HAVING count(PC.MACB) >= 2

/* Q31 */
SELECT MACB, NGAYDI, count(MAKH) SoLuongKhachHang
FROM DATCHO
GROUP BY MACB, NGAYDI
HAVING count(MAKH) < 3

/* Q32 */
SELECT MB.SOHIEU, MB.MALOAI, count(PC.MANV)
FROM MAYBAY MB join LICHBAY LB on MB.MALOAI = LB.MALOAI
	join PHANCONG PC on PC.MACB = LB.MACB and PC.NGAYDI = LB.NGAYDI
WHERE PC.MANV = 1001
GROUP BY MB.SOHIEU, MB.MALOAI
HAVING count(PC.MANV) > 2

/* Q33 */
SELECT LMB.HANGSX, count(LMB.MALOAI) SoLuong
FROM LOAIMB LMB join MAYBAY MB on MB.MALOAI = LMB.MALOAI
GROUP BY LMB.HANGSX

/* Q34 */
SELECT LB.SOHIEU, LMB.HANGSX, LMB.MALOAI, count(LB.MACB) SoLuongChuyenBay
FROM LICHBAY LB join LOAIMB LMB on LB.MALOAI = LMB.MALOAI
	join CHUYENBAY CB on CB.MACB = LB.MACB
GROUP BY LB.SOHIEU, LMB.HANGSX, LMB.MALOAI
HAVING count(LB.MACB) = (SELECT TOP 1 count(LB1.MACB)
						 FROM LICHBAY LB1 join LOAIMB LMB1 on LB1.MALOAI = LMB1.MALOAI
							join CHUYENBAY CB1 on CB1.MACB = LB1.MACB
						 GROUP BY LMB1.HANGSX,LMB1.MALOAI,LB1.SOHIEU
						 ORDER BY count(LB1.MACB) DESC)
/* Q35 */
SELECT NV.TEN, count(PC.MACB) SoChuyenBay
FROM NHANVIEN NV join PHANCONG PC on NV.MANV = PC.MANV
GROUP BY NV.TEN
HAVING COUNT(PC.MACB) = (SELECT TOP 1 count(PC1.MACB)
						 FROM NHANVIEN NV1 join PHANCONG PC1 on NV1.MANV = PC1.MANV
						 GROUP BY NV1.MANV
						 ORDER BY count(PC1.MACB) DESC)
/* Q36 */
SELECT NV.TEN, NV.DCHI, NV.DTHOAI, count(PC.MACB) SoChuyenBay
FROM NHANVIEN NV join PHANCONG PC on NV.MANV = PC.MANV
WHERE NV.LOAINV = 1
GROUP BY NV.TEN, NV.DCHI, NV.DTHOAI
HAVING COUNT(PC.MACB) = (SELECT TOP 1 count(PC1.MACB)
						 FROM NHANVIEN NV1 join PHANCONG PC1 on NV1.MANV = PC1.MANV
						 WHERE NV1.LOAINV = 1
						 GROUP BY NV1.MANV
						 ORDER BY count(PC1.MACB) DESC)
/* Q37 */
SELECT CB.SBDEN, count(CB.MACB) SoChuyenBayHaCanh
FROM CHUYENBAY CB
GROUP BY CB.SBDEN
HAVING count(CB.MACB) = (SELECT TOP 1 count(CB1.MACB)
						 FROM CHUYENBAY CB1
						 GROUP BY CB1.SBDEN
						 ORDER BY count(CB1.MACB))
/* Q38 */
SELECT CB.SBDI, count(CB.MACB) SoChuyenBayCatCanh
FROM CHUYENBAY CB join LICHBAY LB on CB.MACB = LB.MACB
WHERE DATEDIFF(dd,LB.NGAYDI,getdate()) > 1
GROUP BY CB.SBDI
HAVING count(CB.MACB) = (SELECT TOP 1 count(CB1.MACB)
						 FROM CHUYENBAY CB1 join LICHBAY LB1 on CB1.MACB = LB1.MACB
						 GROUP BY CB1.SBDI
						 ORDER BY count(CB1.MACB) DESC)
/* Q39 */
select KH.TEN,KH.DCHI,KH.DTHOAI, COUNT(CB.MACB) SoChuyenBayDaDi
from KHACHHANG KH,DATCHO DC,CHUYENBAY CB
where KH.MAKH=DC.MAKH and DC.MACB=CB.MACB 
group by KH.TEN,KH.DCHI,KH.DTHOAI
having COUNT(CB.MACB)=(select top 1 COUNT (CB1.MACB)
					from KHACHHANG KH1,DATCHO DC1,CHUYENBAY CB1
					where KH1.MAKH=DC1.MAKH and DC1.MACB=CB1.MACB 
					group by KH1.TEN,KH1.DCHI,KH1.DTHOAI
					order by COUNT(CB1.MACB) desc)
/* Q40 */
SELECT KN.MANV, NV.TEN, NV.LUONG, count(KN.MALOAI) SoLoaiMayBayCoTheLai
FROM NHANVIEN NV join KHANANG KN on NV.MANV = KN.MANV
WHERE NV.LOAINV = 1 
GROUP BY KN.MANV, NV.TEN, NV.LUONG
HAVING count(KN.MALOAI) = (SELECT TOP 1 count(KN1.MALOAI) 
						   FROM KHANANG KN1
						   GROUP BY KN1.MANV)
/* Q41 */
SELECT MANV, TEN, max(LUONG) NhanVienCoMucLuongCaoNhat
FROM NHANVIEN NV
GROUP BY MANV, TEN
HAVING max(LUONG) = (SELECT TOP 1 max(LUONG)
					 FROM NHANVIEN NV1
					 GROUP BY NV1.MANV,NV1.TEN)
/* Q42 */
SELECT PC.MACB, PC.MANV, PC.NGAYDI, NV.LUONG
FROM PHANCONG PC join NHANVIEN NV on NV.MANV = PC.MANV
GROUP BY PC.MACB, PC.MANV, PC.NGAYDI, NV.LUONG
HAVING max(NV.LUONG) = (SELECT TOP 1 max(NV1.LUONG)
						FROM PHANCONG PC1 join NHANVIEN NV1 on NV1.MANV = PC1.MANV
						GROUP BY PC1.MACB, PC1.MANV, PC1.NGAYDI)
/* Q43 */
SELECT CB.MACB, CB.GIODI, CB.GIODEN
FROM LICHBAY LB join CHUYENBAY CB on LB.MACB = CB.MACB
WHERE EXISTS (SELECT * 
			  FROM  LICHBAY LB1 join CHUYENBAY CB1 on LB1.MACB = CB1.MACB and LB1.NGAYDI = LB.NGAYDI
			  GROUP BY LB1.NGAYDI
			  HAVING CB.GIODI = min(CB1.GIODI))
/* Q44 */
SELECT CB.MACB, (DATEDIFF(mi,CB.GIODI,CB.GIODEN)) ThoiGianBay
FROM CHUYENBAY CB
WHERE (DATEDIFF(mi,CB.GIODI,CB.GIODEN)) >= ALL (SELECT DATEDIFF(mi,CB.GIODI,CB.GIODEN)
											   FROM CHUYENBAY CB)
/* Q45 */
SELECT CB.MACB, (DATEDIFF(mi,CB.GIODI,CB.GIODEN)) ThoiGianBay
FROM CHUYENBAY CB
WHERE (DATEDIFF(mi,CB.GIODI,CB.GIODEN)) <= ALL (SELECT DATEDIFF(mi,CB.GIODI,CB.GIODEN)
											   FROM CHUYENBAY CB)
/* Q46 */
SELECT LB.NGAYDI, LB.MACB, count(*)
FROM LICHBAY LB
WHERE LB.MALOAI = 'B747'
GROUP BY LB.NGAYDI, LB.MACB

/* Q47 */
SELECT PC.MACB, count(*)
FROM PHANCONG PC
WHERE EXISTS (SELECT count(*)
			  FROM DATCHO DC 
			  WHERE DC.MACB = PC.MACB and PC.NGAYDI=DC.NGAYDI 
			  GROUP BY DC.MACB
			  HAVING count(*) >= 3)
GROUP BY PC.MACB

/* Q48 */
SELECT LOAINV,count(*)
FROM NHANVIEN
WHERE EXISTS (SELECT count(*)
			  FROM NHANVIEN NV
			  GROUP BY NV.LOAINV
			  HAVING sum(NV.LUONG) > 600000)
GROUP BY LOAINV

/* Q49 */
SELECT DC.MACB, count(*) SoLuongKhachHang
FROM DATCHO DC
WHERE EXISTS (SELECT count(*)
			  FROM PHANCONG PC 
			  WHERE DC.MACB = PC.MACB and PC.NGAYDI=DC.NGAYDI 
			  GROUP BY PC.MACB
			  HAVING count(*) >= 3)
GROUP BY DC.MACB

/* Q50 */
SELECT MALOAI, count(*)
FROM LICHBAY LB	
WHERE EXISTS (SELECT count(*)
			  FROM LICHBAY LB1
			  WHERE LB1.MALOAI = LB.MALOAI
			  GROUP BY LB1.MALOAI
			  HAVING count(*) > 1)
GROUP BY LB.MALOAI

/* Q51 */ 
SELECT LB.MACB, LB.MALOAI
FROM LICHBAY LB
WHERE EXISTS (SELECT *
			  FROM LOAIMB LMB
			  WHERE LMB.MALOAI = LB.MALOAI AND LMB.HANGSX = 'Boeing')

